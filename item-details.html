<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Product Details</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header>
        <div class="logo">üè´ STUDENT MARKETPLACE</div>
        <nav>
            <a href="listings.html">Back to Listings</a>
            <a href="cart.html">Cart</a>
        </nav>
    </header>
    <div id="loadingMessage" class="loading">Loading product...</div>
    <div id="errorMessage" style="display: none;" class="error-message"></div>
    <div id="successMessage" style="display: none;" class="success-message"></div>
    <section class="product-details" id="productDetails" style="display: none;">
        <!-- Product details will be loaded here -->
    </section>
    <section class="comments" id="commentsSection" style="display: none;">
        <h3>Comments</h3>
        <div class="comment-box" id="commentBox" style="display: none;">
            <textarea id="commentText" placeholder="Write a comment..." maxlength="500"></textarea>
            <button class="btn" id="postCommentBtn">Post Comment</button>
        </div>
        <div id="commentsList">
            <!-- Comments will be loaded here -->
        </div>
    </section>
    <footer>
        <p>¬©Ô∏è 2025 STUDENT MARKETPLACE</p>
    </footer>

    <script type="module">
        import { auth, onAuthStateChanged } from './js/firebase-config.js';
        import { getProductById } from './js/products.js';
        import { addToCart } from './js/cart.js';
        import { addComment, listenToComments } from './js/comments.js';

        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const productDetails = document.getElementById('productDetails');
        const commentsSection = document.getElementById('commentsSection');
        const commentBox = document.getElementById('commentBox');
        const commentsList = document.getElementById('commentsList');

        let currentUser = null;

        if (!productId) {
            loadingMessage.style.display = 'none';
            errorMessage.textContent = 'Product not found';
            errorMessage.style.display = 'block';
        } else {
            // Check auth state
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    commentBox.style.display = 'block';
                }
            });

            // Load product details
            try {
                const product = await getProductById(productId);
                loadingMessage.style.display = 'none';
                productDetails.style.display = 'flex';
                commentsSection.style.display = 'block';

                const imageUrl = product.imageUrl || 'https://via.placeholder.com/400x400/E57A79/FFFFFF?text=Product+Image';
                productDetails.innerHTML = `
                    <img src="${imageUrl}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/400x400/E57A79/FFFFFF?text=No+Image'">
                    <div class="info">
                        <h2>${product.name}</h2>
                        <p class="price">‚Çπ${product.price}</p>
                        <p class="desc">${product.description || 'No description available.'}</p>
                        <p><strong>Stock:</strong> ${product.stock} available</p>
                        <p><strong>Seller:</strong> ${product.sellerName || 'Unknown'}</p>
                        <button class="btn accent" id="addToCartBtn">Add to Cart</button>
                    </div>
                `;

                // Add to cart handler
                document.getElementById('addToCartBtn').addEventListener('click', async () => {
                    if (!currentUser) {
                        alert('Please login to add items to cart');
                        window.location.href = 'login.html';
                        return;
                    }

                    try {
                        await addToCart(currentUser.uid, productId, 1);
                        successMessage.textContent = 'Product added to cart!';
                        successMessage.style.display = 'block';
                        setTimeout(() => {
                            successMessage.style.display = 'none';
                        }, 3000);
                    } catch (error) {
                        errorMessage.textContent = 'Error adding to cart. Please try again.';
                        errorMessage.style.display = 'block';
                    }
                });

                // Load comments
                listenToComments(productId, (comments) => {
                    commentsList.innerHTML = '';
                    if (comments.length === 0) {
                        commentsList.innerHTML = '<p style="color: #666;">No comments yet. Be the first to comment!</p>';
                    } else {
                        comments.forEach(comment => {
                            const commentDiv = document.createElement('div');
                            commentDiv.className = 'comment';
                            const date = comment.createdAt ? new Date(comment.createdAt.seconds * 1000).toLocaleDateString() : '';
                            commentDiv.innerHTML = `
                                <strong>${comment.userName}:</strong> ${comment.commentText}
                                <span style="font-size: 0.8em; color: #666; margin-left: 10px;">${date}</span>
                            `;
                            commentsList.appendChild(commentDiv);
                        });
                    }
                });

                // Post comment handler
                document.getElementById('postCommentBtn').addEventListener('click', async () => {
                    const commentText = document.getElementById('commentText').value.trim();
                    
                    if (!commentText) {
                        alert('Please enter a comment');
                        return;
                    }

                    if (commentText.length > 500) {
                        alert('Comment must be 500 characters or less');
                        return;
                    }

                    try {
                        const userName = localStorage.getItem('userName') || 'Anonymous';
                        await addComment(productId, currentUser.uid, userName, commentText);
                        document.getElementById('commentText').value = '';
                        successMessage.textContent = 'Comment posted!';
                        successMessage.style.display = 'block';
                        setTimeout(() => {
                            successMessage.style.display = 'none';
                        }, 3000);
                    } catch (error) {
                        errorMessage.textContent = 'Error posting comment. Please try again.';
                        errorMessage.style.display = 'block';
                    }
                });

            } catch (error) {
                console.error('Error loading product:', error);
                loadingMessage.style.display = 'none';
                errorMessage.textContent = 'Error loading product. Please try again.';
                errorMessage.style.display = 'block';
            }
        }
    </script>
</body>
</html>
